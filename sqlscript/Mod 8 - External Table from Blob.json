{
	"name": "Mod 8 - External Table from Blob",
	"properties": {
		"folder": {
			"name": "ASA 30 days Challenge"
		},
		"content": {
			"query": "\n-- Tratando de hacer el tutorial a mi manera\n-- Transform data with Azure Synapse serverless SQL pools using CREATE EXTERNAL TABLE AS SELECT statement\n-- https://docs.microsoft.com/en-us/learn/modules/use-azure-synapse-serverless-sql-pools-for-transforming-data-lake/2-transform-data-using-create-external-table-select-statement\n\n--select * from sys.credentials\n\n------------------------------------\n--\n-- NO PUDE EVITAR EL ERROR:\n-- External table location path is not valid. Location provided: 'https://synapsdaystorage.blob.core.windows.net/destination-ds/aggregated_data/'\n-- Posiblemente falte una configuración o permisología porque\n-- tampoco cuando hago botón derecho sobre el csv me aparece la opción de crear tabla, como me aparece con el datalake\n-- Haciendo pruebas en el blob storage de Microsoft salieron, ver script \"Mod 8 - Create and use external tables docs\"\n\n-- AL FIN LO LOGRÉ... Generando el SAS Token con acceso a lectura, escritura...\n-- Se coloca en la credencial y es algo así:\n-- SECRET = 'sp=racwdli&st=2021-12-26T15:21:40Z&se=2021-12-26T23:21:40Z&spr=https&sv=2020-08-04&sr=c&sig=9ud (...) rqyIHoQA%3D'\n-- https://docs.microsoft.com/en-us/answers/questions/326123/azure-synapse-serverless-query-error-with-access-c.html\n------------------------------------\n\n--CREATE DATABASE ExternalBlobTable\n--GO\nUSE ExternalBlobTable\n\nIF (SELECT COUNT(*) FROM sys.symmetric_keys WHERE name LIKE '%DatabaseMasterKey%') = 0\nBEGIN\n    CREATE MASTER KEY ENCRYPTION BY PASSWORD = '10042076CIpa';\nEND\nGO\n\nIF EXISTS\n   (SELECT * FROM sys.credentials\n   WHERE name = 'ExternalBlobCredential')\n   DROP CREDENTIAL [ExternalBlobCredential]\nGO\n\nCREATE CREDENTIAL [ExternalBlobCredential]\nWITH IDENTITY='User Identity';\n\nIF (EXISTS(SELECT * FROM sys.external_tables WHERE name = 'aggregated_data')) BEGIN\n    DROP EXTERNAL TABLE aggregated_data\nEND\n\nIF (EXISTS(SELECT * FROM sys.external_data_sources WHERE name = 'new_destination')) BEGIN\n    DROP EXTERNAL DATA SOURCE new_destination\nEND\n\nIF (EXISTS\n    (SELECT * FROM sys.external_file_formats \n    WHERE name = 'parquet_format')) BEGIN\n    DROP EXTERNAL FILE FORMAT parquet_format\nEND\n\nIF EXISTS\n   (SELECT * FROM sys.database_scoped_credentials\n   WHERE name = 'dest_creds')\n   DROP DATABASE SCOPED CREDENTIAL [dest_creds]\nGO\n\n\n------------------------------------------------------------------------------------------\n--      \n--      This part creates required objects as in tutorial\n------------------------------------------------------------------------------------------\n\nCREATE DATABASE SCOPED CREDENTIAL dest_creds\nWITH IDENTITY = 'SHARED ACCESS SIGNATURE',  \n\t--SECRET = 'oSDLGqLdXS51BUs32boIpT8ClQMhGzraXaZsiOwe1fOGyYdJ3uau3iGbhP3mudEyINtWLpcewiN6Y/375VEQeQ==' -- fill in your SAS key that will be used for CETAS destination\n    -- Hay que generar este token porque por defecto se vence rápido\n    SECRET = 'sp=racwdli&st=2021-12-27T20:17:04Z&se=2021-12-28T04:17:04Z&spr=https&sv=2020-08-04&sr=c&sig=hPrxVXLkFarBcrOf7rXQd4xHi1A5Q%2FeXj2K3lcujWPU%3D'\nGO\n\n-- https://synapsdaystorage.blob.core.windows.net/destination-ds?sp=racwdl&st=2021-12-26T14:14:37Z&se=2021-12-27T14:14:37Z&sv=2020-08-04&sr=c&sig=iS226ojIBRhjQSiSOBASI1%2FSo510rBOddmDHrZLSCI4%3D\nCREATE EXTERNAL DATA SOURCE new_destination\nWITH\n(    \n    -- Folder new-destination!\n    LOCATION = 'https://synapsdaystorage.blob.core.windows.net/new-destination/',\n    --LOCATION = 'wasbs://destination-ds@synapsdaystorage.blob.core.windows.net',\n    -- LOCATION = 'https://synapsdaystorage.blob.core.windows.net/destination-ds?sp=racwdl&st=2021-12-26T14:14:37Z&se=2021-12-27T14:14:37Z&sv=2020-08-04&sr=c&sig=iS226ojIBRhjQSiSOBASI1%2FSo510rBOddmDHrZLSCI4%3D',\n    CREDENTIAL = dest_creds\n)\nGO\n\nCREATE EXTERNAL FILE FORMAT parquet_format\nWITH\n(  \n    FORMAT_TYPE = PARQUET,\n    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'\n)\nGO\n\n-- use CETAS to export select statement with OPENROWSET result to  storage\nCREATE EXTERNAL TABLE aggregated_data\nWITH (\n    LOCATION = 'aggregated_data/',\n    DATA_SOURCE = new_destination,  \n    FILE_FORMAT = parquet_format\n)  \nAS\nSELECT decennialTime, stateName, SUM(population) AS population\nFROM\n    OPENROWSET(BULK 'https://azureopendatastorage.blob.core.windows.net/censusdatacontainer/release/us_population_county/year=*/*.parquet',\n    FORMAT='PARQUET') AS [r]\nGROUP BY decennialTime, stateName\nGO\n\n-- you can query the newly created external table\nSELECT * FROM aggregated_data",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "ExternalBlobTable",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
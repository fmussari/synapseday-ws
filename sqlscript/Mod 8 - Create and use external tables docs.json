{
	"name": "Mod 8 - Create and use external tables docs",
	"properties": {
		"folder": {
			"name": "ASA 30 days Challenge"
		},
		"content": {
			"query": "-- Create and use native external tables using SQL pools in Azure Synapse Analytics\n-- https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/create-use-external-tables\n\n\nUSE [ExternalBlobTable];\nGO\n\n-- Drop Tables\nIF (EXISTS(SELECT * FROM sys.external_tables WHERE name = 'populationExternalTable')) BEGIN\n    DROP EXTERNAL TABLE populationExternalTable\nEND\nGO\nIF (EXISTS(SELECT * FROM sys.external_tables WHERE name = 'Taxi')) BEGIN\n    DROP EXTERNAL TABLE Taxi\nEND\nGO\nIF (EXISTS(SELECT * FROM sys.external_tables WHERE name = 'Covid')) BEGIN\n    DROP EXTERNAL TABLE Covid\nEND\nGO\n\n-- Drop File Formats\nIF (EXISTS\n    (SELECT * FROM sys.external_file_formats \n    WHERE name = 'QuotedCsvWithHeaderFormat')) BEGIN\n    DROP EXTERNAL FILE FORMAT QuotedCsvWithHeaderFormat\nEND\nGO\nIF (EXISTS\n    (SELECT * FROM sys.external_file_formats \n    WHERE name = 'ParquetFormat')) BEGIN\n    DROP EXTERNAL FILE FORMAT ParquetFormat\nEND\nGO\nIF (EXISTS\n    (SELECT * FROM sys.external_file_formats \n    WHERE name = 'DeltaLakeFormat')) BEGIN\n    DROP EXTERNAL FILE FORMAT DeltaLakeFormat\nEND\nGO\n\n-- Drop Data Sources\nIF (EXISTS(SELECT * FROM sys.external_data_sources WHERE name = 'SqlOnDemandDemo')) BEGIN\n    DROP EXTERNAL DATA SOURCE SqlOnDemandDemo\nEND\n\nIF (EXISTS(SELECT * FROM sys.external_data_sources WHERE name = 'nyctlc')) BEGIN\n    DROP EXTERNAL DATA SOURCE nyctlc\nEND\n\nIF (EXISTS(SELECT * FROM sys.external_data_sources WHERE name = 'DeltaLakeStorage')) BEGIN\n    DROP EXTERNAL DATA SOURCE DeltaLakeStorage\nEND\n-- Drop Credentials\nIF EXISTS\n   (SELECT * FROM sys.database_scoped_credentials\n   WHERE name = 'sqlondemand')\n   DROP DATABASE SCOPED CREDENTIAL [sqlondemand]\nGO\n\n\n----------------------------------\n-- CREATION\n----------------------------------\n\n-- Credentials\nCREATE DATABASE SCOPED CREDENTIAL [sqlondemand]\nWITH IDENTITY='SHARED ACCESS SIGNATURE',  \nSECRET = 'sv=2018-03-28&ss=bf&srt=sco&sp=rl&st=2019-10-14T12%3A10%3A25Z&se=2061-12-31T12%3A10%3A00Z&sig=KlSU2ullCscyTS0An0nozEpo4tO5JAgGBvw%2FJX2lguw%3D'\n\n-- Data Sources\nCREATE EXTERNAL DATA SOURCE SqlOnDemandDemo WITH (\n    LOCATION = 'https://sqlondemandstorage.blob.core.windows.net',\n    CREDENTIAL = sqlondemand\n);\nGO\nCREATE EXTERNAL DATA SOURCE nyctlc\nWITH ( LOCATION = 'https://azureopendatastorage.blob.core.windows.net/nyctlc/')\nGO\nCREATE EXTERNAL DATA SOURCE DeltaLakeStorage\nWITH ( location = 'https://sqlondemandstorage.blob.core.windows.net/delta-lake/' );\n\n-- File Formats\nCREATE EXTERNAL FILE FORMAT QuotedCsvWithHeaderFormat\nWITH (  \n    FORMAT_TYPE = DELIMITEDTEXT,\n    FORMAT_OPTIONS ( FIELD_TERMINATOR = ',', STRING_DELIMITER = '\"', FIRST_ROW = 2   )\n);\nGO\nCREATE EXTERNAL FILE FORMAT ParquetFormat WITH (  FORMAT_TYPE = PARQUET );\nGO\nCREATE EXTERNAL FILE FORMAT DeltaLakeFormat WITH (  FORMAT_TYPE = DELTA );\nGO\n\n-- External table on a file\nCREATE EXTERNAL TABLE populationExternalTable\n(\n    [country_code] VARCHAR (5) COLLATE Latin1_General_BIN2,\n    [country_name] VARCHAR (100) COLLATE Latin1_General_BIN2,\n    [year] smallint,\n    [population] bigint\n)\nWITH (\n    LOCATION = 'csv/population/population.csv',\n    DATA_SOURCE = sqlondemanddemo,\n    FILE_FORMAT = QuotedCSVWithHeaderFormat\n);\n\n-- External table on a set of files\n\n-- Esto crea la tabla full de Nulls, porque esos no son los nombres de las columnas...\nCREATE EXTERNAL TABLE Taxi (\n     vendor_id VARCHAR(100) COLLATE Latin1_General_BIN2, \n     pickup_datetime DATETIME2, \n     dropoff_datetime DATETIME2,\n     passenger_count INT,\n     trip_distance FLOAT,\n     fare_amount FLOAT,\n     tip_amount FLOAT,\n     tolls_amount FLOAT,\n     total_amount FLOAT\n) WITH (\n         LOCATION = 'yellow/puYear=*/puMonth=*/*.parquet',\n         DATA_SOURCE = nyctlc,\n         FILE_FORMAT = ParquetFormat\n);\n\n-- External table on appendable files\n/*CREATE EXTERNAL TABLE populationExternalTable\n(\n    [country_code] VARCHAR (5) COLLATE Latin1_General_BIN2,\n    [country_name] VARCHAR (100) COLLATE Latin1_General_BIN2,\n    [year] smallint,\n    [population] bigint\n)\nWITH (\n    LOCATION = 'csv/population/population.csv',\n    DATA_SOURCE = sqlondemanddemo,\n    FILE_FORMAT = QuotedCSVWithHeaderFormat,\n    TABLE_OPTIONS = N'{\"READ_OPTIONS\":[\"ALLOW_INCONSISTENT_READS\"]}'\n);*/\n\n-- Delta Lake external table\nCREATE EXTERNAL TABLE Covid (\n     date_rep date,\n     cases int,\n     geo_id varchar(6)\n) WITH (\n        LOCATION = 'covid', --> the root folder containing the Delta Lake files\n        data_source = DeltaLakeStorage,\n        FILE_FORMAT = DeltaLakeFormat\n);\n\n-- you can query the newly created external table\n--SELECT * FROM populationExternalTable\nSELECT\n    country_name, population\nFROM populationExternalTable\nWHERE\n    [year] = 2019\nORDER BY\n    [population] DESC;\n\n--SELECT COUNT(*) FROM Taxi\n\nSELECT date_rep, cases FROM Covid\n\n-- https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/create-external-table-as-select\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "ExternalBlobTable",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}